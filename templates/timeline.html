{% extends "base.html" %}

{% block title %}Compliance Timeline - Landlord Command Centre{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h1>Compliance Timeline</h1>
</div>

<!-- Filters -->
<div class="card" style="margin-bottom: 1.5rem;">
    <form method="GET" style="display: flex; gap: 1rem; align-items: end; flex-wrap: wrap;">
        <div class="form-group" style="margin-bottom: 0;">
            <label for="property_id">Property</label>
            <select id="property_id" name="property_id" style="min-width: 200px;">
                <option value="">All Properties</option>
                {% for prop in properties %}
                <option value="{{ prop.id }}" {% if selected_property_id == prop.id %}selected{% endif %}>
                    {{ prop.address }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
            <label for="days">Show next</label>
            <select id="days" name="days">
                <option value="30" {% if selected_days == 30 %}selected{% endif %}>30 days</option>
                <option value="60" {% if selected_days == 60 %}selected{% endif %}>60 days</option>
                <option value="90" {% if selected_days == 90 %}selected{% endif %}>90 days</option>
                <option value="180" {% if selected_days == 180 %}selected{% endif %}>6 months</option>
                <option value="365" {% if selected_days == 365 %}selected{% endif %}>1 year</option>
            </select>
        </div>
        <button type="submit" class="btn">Filter</button>
    </form>
</div>

<!-- Overdue Events -->
{% if overdue %}
<div class="card" style="border-left: 4px solid #dc3545;">
    <h2 style="color: #dc3545;">‚ö†Ô∏è Overdue ({{ overdue | length }})</h2>
    <table>
        <thead>
            <tr>
                <th>Due Date</th>
                <th>Priority</th>
                <th>Task</th>
                <th>Description</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for event in overdue %}
            <tr>
                <td style="color: #dc3545; font-weight: bold;">
                    {{ event.due_date.strftime('%d %b %Y') if event.due_date else '-' }}
                    <br><small>{{ (event.due_date - today).days if event.due_date else 0 }} days ago</small>
                </td>
                <td>
                    {% if event.priority == EventPriority.CRITICAL %}
                        <span class="badge badge-danger">CRITICAL</span>
                    {% elif event.priority == EventPriority.HIGH %}
                        <span class="badge badge-warning">HIGH</span>
                    {% else %}
                        <span class="badge">{{ event.priority.value | upper }}</span>
                    {% endif %}
                </td>
                <td><strong>{{ event.event_name }}</strong></td>
                <td style="color: #666; font-size: 0.9rem;">{{ event.notes[:100] }}...</td>
                <td>
                    <form method="POST" action="{{ url_for('complete_event', event_id=event.id) }}" style="display: inline;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">
                            ‚úì Done
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Upcoming Events -->
<div class="card">
    <h2>üìÖ Upcoming ({{ upcoming | length }})</h2>
    {% if upcoming %}
    <table>
        <thead>
            <tr>
                <th>Due Date</th>
                <th>Priority</th>
                <th>Task</th>
                <th>Description</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for event in upcoming %}
            <tr>
                <td>
                    {% set days_until = (event.due_date - today).days if event.due_date else 0 %}
                    {% if days_until <= 7 %}
                        <span style="color: #ffc107; font-weight: bold;">
                    {% else %}
                        <span>
                    {% endif %}
                        {{ event.due_date.strftime('%d %b %Y') if event.due_date else '-' }}
                    </span>
                    <br><small>in {{ days_until }} days</small>
                </td>
                <td>
                    {% if event.priority == EventPriority.CRITICAL %}
                        <span class="badge badge-danger">CRITICAL</span>
                    {% elif event.priority == EventPriority.HIGH %}
                        <span class="badge badge-warning">HIGH</span>
                    {% else %}
                        <span class="badge">{{ event.priority.value | upper }}</span>
                    {% endif %}
                </td>
                <td><strong>{{ event.event_name }}</strong></td>
                <td style="color: #666; font-size: 0.9rem;">{{ event.notes[:100] }}...</td>
                <td>
                    <form method="POST" action="{{ url_for('complete_event', event_id=event.id) }}" style="display: inline;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">
                            ‚úì Done
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #666; text-align: center; padding: 2rem;">
        No upcoming events in the selected period. üéâ
    </p>
    {% endif %}
</div>

{% set today = today or None %}
{% endblock %}
